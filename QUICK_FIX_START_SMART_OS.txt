# Quick Fix for Start Smart OS Error
# Copy and paste this entire block on your server:

cd ~/tool-thinker

# Fix API route
cat > app/api/projects/route.ts << 'APIEOF'
import { NextRequest, NextResponse } from "next/server"
import { db } from "@/lib/db/client"

const MOCK_USER_ID = "user-1"

export async function GET(req: NextRequest) {
  try {
    const projects = await db.getProjects(MOCK_USER_ID)
    return NextResponse.json(Array.isArray(projects) ? projects : [])
  } catch (error: any) {
    console.error("Error fetching projects:", error)
    return NextResponse.json([], { status: 200 })
  }
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json()
    const { name } = body

    if (!name) {
      return NextResponse.json(
        { error: "Project name is required" },
        { status: 400 }
      )
    }

    const project = await db.createProject(MOCK_USER_ID, name)
    await db.logEvent(MOCK_USER_ID, "project_created", { projectId: project.id }, project.id)
    
    return NextResponse.json(project)
  } catch (error: any) {
    console.error("Error creating project:", error)
    return NextResponse.json(
      { error: error.message || "Failed to create project" },
      { status: 500 }
    )
  }
}
APIEOF

# Fix Supabase env vars (if needed)
if grep -q "^PUBLIC_SUPABASE_URL" .env 2>/dev/null; then
  sed -i 's/^PUBLIC_SUPABASE_URL/NEXT_PUBLIC_SUPABASE_URL/' .env
fi
if grep -q "^PUBLIC_SUPABASE_ANON_KEY" .env 2>/dev/null; then
  sed -i 's/^PUBLIC_SUPABASE_ANON_KEY/NEXT_PUBLIC_SUPABASE_ANON_KEY/' .env
fi

# Ensure variables exist
if ! grep -q "NEXT_PUBLIC_SUPABASE_URL" .env 2>/dev/null; then
  echo "" >> .env
  echo "NEXT_PUBLIC_SUPABASE_URL=https://dejhoudyhqjxbcnrixdd.supabase.co" >> .env
fi
if ! grep -q "NEXT_PUBLIC_SUPABASE_ANON_KEY" .env 2>/dev/null; then
  echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=sb_publishable_agg_FhijhDhOMGwGP_w-6A_Vty1Qaq-" >> .env
fi

# Rebuild
npm run build && pm2 restart tool-thinker

echo "âœ… Fix applied! The API will now return empty array instead of error object."

